# Структура базы данных и работа контроллеров

## Модели базы данных

### User
Модель пользователя содержит информацию о пользователях системы:
- `email` - Уникальный email пользователя
- `username` - Уникальное имя пользователя
- `password` - Хешированный пароль (с использованием bcrypt)
- `avatar` - URL аватара пользователя
- `status` - Статус пользователя (online/offline)
- `custom` - Объект с настраиваемыми параметрами:
  - `backgroundColor` - Цвет фона профиля
  - `bio` - Краткая биография

Модель имеет следующие методы:
- `comparePassword` - Метод для сравнения введенного пароля с хешированным

### Chat
Модель чата представляет собой групповые и личные чаты:
- `isGroup` - Флаг, указывающий является ли чат групповым
- `name` - Название чата (для групповых)
- `participants` - Массив ID пользователей, участвующих в чате
- `creator` - ID пользователя, создавшего чат
- `custom` - Объект с настраиваемыми параметрами:
  - `themeColor` - Цвет темы чата
  - `icon` - Иконка чата
- `lastMessage` - Ссылка на последнее сообщение в чате

### Message
Модель сообщения:
- `chatId` - ID чата, к которому относится сообщение
- `sender` - ID пользователя, отправившего сообщение
- `text` - Текст сообщения
- `readBy` - Массив ID пользователей, прочитавших сообщение

## Связи между моделями

1. **User и Chat**:
   - Многие-ко-многим: Пользователи могут участвовать во многих чатах, и чаты могут содержать многих пользователей
   - Связь через поле `participants` в модели Chat
   - Один-ко-многим: Пользователь может быть создателем многих чатов (связь через поле `creator`)

2. **Chat и Message**:
   - Один-ко-многим: Чат содержит много сообщений, каждое сообщение принадлежит одному чату
   - Связь через поле `chatId` в модели Message
   - Один-к-одному: Чат имеет одно последнее сообщение (связь через поле `lastMessage`)

3. **User и Message**:
   - Один-ко-многим: Пользователь может отправить много сообщений
   - Связь через поле `sender` в модели Message
   - Многие-ко-многим: Сообщения могут быть прочитаны многими пользователями
   - Связь через поле `readBy` в модели Message

## Контроллеры

### authController
Отвечает за аутентификацию пользователей:
- `register` - Регистрация нового пользователя
- `login` - Вход пользователя
- `getCurrentUser` - Получение информации о текущем пользователе

### userController
Управляет профилями пользователей:
- `getUserProfile` - Получение профиля текущего пользователя
- `updateUserProfile` - Обновление профиля пользователя
- `getUserById` - Получение профиля пользователя по ID
- `searchUsers` - Поиск пользователей по имени или email

### chatController
Управляет чатами:
- `createChat` - Создание нового чата (личного или группового)
- `getChats` - Получение всех чатов пользователя
- `getChatById` - Получение чата по ID
- `updateChat` - Обновление настроек чата
- `addParticipants` - Добавление участников в групповой чат
- `removeParticipant` - Удаление участника из группового чата

### messageController
Управляет сообщениями:
- `sendMessage` - Отправка нового сообщения
- `getMessages` - Получение сообщений чата
- `markAsRead` - Отметка сообщения как прочитанного
- `deleteMessage` - Удаление сообщения

## Процесс работы приложения

1. **Регистрация и аутентификация**:
   - Пользователь регистрируется через `authController.register`
   - При входе в систему через `authController.login` генерируется JWT токен
   - Токен используется для аутентификации всех последующих запросов

2. **Управление чатами**:
   - Пользователь может создать личный чат с другим пользователем или групповой чат
   - При создании личного чата проверяется, не существует ли уже чат с этим пользователем
   - Для групповых чатов создатель может добавлять и удалять участников

3. **Обмен сообщениями**:
   - Сообщения отправляются в конкретный чат
   - При отправке сообщения оно автоматически отмечается как прочитанное отправителем
   - Обновляется поле `lastMessage` в модели Chat
   - Когда пользователь открывает чат, все непрочитанные сообщения отмечаются как прочитанные

4. **Реальное время с Socket.IO**:
   - При подключении пользователя обновляется его статус на "online"
   - При отправке сообщения через сокет, оно сохраняется в базе данных и отправляется всем участникам чата
   - Статус "прочитано" также обновляется в реальном времени
   - Индикаторы набора текста отправляются через сокеты

## Особенности реализации

1. **Безопасность**:
   - Пароли хешируются с использованием bcrypt
   - JWT используется для аутентификации
   - Проверки авторизации во всех контроллерах

2. **Оптимизация**:
   - Пагинация для сообщений
   - Выборочная загрузка полей (без пароля)
   - Индексация полей в MongoDB для быстрого поиска

3. **Обработка ошибок**:
   - Подробные сообщения об ошибках
   - Проверка входных данных
   - Обработка исключений с логированием 